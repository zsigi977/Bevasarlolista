<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Bev√°s√°rl√≥lista</title>

    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lista">

    <link rel="icon" type="image/png" href="icon.png">
    <link rel="shortcut icon" href="icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: url('hatter.png') repeat center center;
            background-size: auto;
            margin: 0; padding: 20px; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        #login-section, #app {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px; padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            width: 90%; max-width: 400px;
            margin-top: 20px;
            position: relative; /* Fontos az aj√°nl√≥ poz√≠cion√°l√°s√°hoz */
        }

        h1 { text-align: center; margin-bottom: 20px; font-size: 24px; }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; position: relative; }
        
        input[type="text"], input[type="password"], select { 
            padding: 12px; border-radius: 10px; border: 1px solid #ccc; 
            font-size: 16px; outline: none; background: #fff !important;
            color: #000; width: 100%; box-sizing: border-box;
        }

        button { padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-size: 16px; }
        .btn-primary { background: #007aff; color: white; font-weight: 600; }
        
        /* EGYEDI AJ√ÅNL√ì LISTA ST√çLUSA */
        #custom-suggestions {
            position: absolute;
            top: 50px; /* Pontosan az input alatt */
            left: 0;
            width: calc(100% - 55px); /* Az input sz√©less√©g√©hez igazodik (m√≠nusz a gomb) */
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none; /* Alapb√≥l rejtve */
        }

        .suggestion-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 16px;
        }

        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:active { background: #f0f0f0; }

        ul { list-style: none; padding: 0; margin-top: 10px; }
        li { 
            background: white; padding: 12px; border-radius: 12px; 
            display: flex; align-items: center; margin-bottom: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .drag-handle { cursor: grab; padding: 0 10px; color: #bbb; font-size: 20px; user-select: none; }
        .checked { text-decoration: line-through; color: #8e8e93; }
        .delete { background: none; font-size: 20px; color: #ff3b30; margin-left: auto; padding: 5px; }
        
        .logout-container { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; background: rgba(0,0,0,0.05); 
            padding: 8px 12px; border-radius: 10px; font-size: 14px;
        }
    </style>
</head>
<body>

<div id="login-section">
    <h1>üõí Lista</h1>
    <div id="login-form">
        <input type="text" id="usernameInput" placeholder="Felhaszn√°l√≥n√©v" autocorrect="off" autocapitalize="none" />
        <input type="password" id="passInput" placeholder="Jelsz√≥" />
        <button id="loginBtn" class="btn-primary">Bel√©p√©s</button>
        <p id="error" style="color:#ff3b30; font-size: 14px; margin-top: 10px; text-align: center;"></p>
    </div>
</div>

<div id="app" style="display:none;">
    <div class="logout-container">
        <span id="user-display"></span>
        <button id="logoutBtn">Kil√©p√©s</button>
    </div>
    
    <h1>Bev√°s√°rl√≥lista</h1>
    
    <div class="controls">
        <input type="text" id="itemInput" placeholder="√öj term√©k..." autocomplete="off" />
        <div id="custom-suggestions"></div> <button id="addBtn" class="btn-primary">‚ûï</button>
    </div>

    <div class="controls">
        <select id="storeSelect">
            <option value="aldi">Aldi</option>
            <option value="penny">Penny</option>
            <option value="spar">Spar</option>
        </select>
        <button id="clearBtn">üóëÔ∏è</button>
    </div>

    <ul id="list"></ul>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCslE4Kc229j41Sm2l7ovpc_KEWhOb107k",
        authDomain: "bevasarlolista-dd660.firebaseapp.com",
        databaseURL: "https://bevasarlolista-dd660-default-rtdb.firebaseio.com",
        projectId: "bevasarlolista-dd660",
        storageBucket: "bevasarlolista-dd660.firebasestorage.app",
        messagingSenderId: "482885096675",
        appId: "1:482885096675:web:f569deb724cb835358e1d6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const itemsRef = ref(db, 'items');

    let items = [];
    let sortable = null;
    let allProductDatabase = [];

    const storeOrders = {
        aldi: ["k√°v√©","tea","m√©z","lekv√°r","nutella","mogyor√≥vaj","gabonapehely","keksz","csoki","gumicukor","√©dess√©g","r√°gcsa","snack","chips","aszalt gy√ºm√∂lcs","mogyor√≥","ban√°n","alma","narancs","citrom","v√©rnarancs","sz≈ël≈ë","gy√ºm√∂lcs","mandarin","gomba","krumpli","bor","feh√©rbor","v√∂r√∂sbor","vodka","gagyi vodka","gagyivodka","pezsg≈ë","s√∂r","mosogat√≥g√©p s√≥","√∂bl√≠t≈ë","mos√≥szer","v√≠zk≈ëold√≥","szemeteszs√°k","pap√≠rt√∂rl≈ë","wcpap√≠r","wc pap√≠r","kuk√°szs√°k","kukazs√°k","tiszt√≠t√≥szer","mosogat√≥g√©p kapszula","tusf√ºrd≈ë","sampon","vattapamacs","fogkefe","fogkr√©m","dezodor","hagyma","fokhagyma","paprika","paradicsom","√∫jhagyma","t√∂k","lilahagyma","r√©pa","levesz√∂lsd√©g","zeller","passata","paradicsomp√ºr√©","paradicsom p√ºr√©","paprikakr√©m","kukorica","konzerv kukorica","kukorica konzerv","saviubi","savany√∫ uborka","paprikakr√©m","paprika kr√©m","guly√°skr√©m","olivbogy√≥","olivabogy√≥","t√©szta","mamat√©szta","mama t√©szta","szarvacska","spagetti","farfelle","penne","rizs","rizsa","tarhonya","cica kaja","pamacskaja","macska kaja","macskakaja","macska alom","macskaalom","cica alom","cicaalom","olaj","olivaolaj","oliva olaj","ecet","liszt","pr√©zli","zsemlemorzsa","s√≥","cukor","barna cukor","van√≠li√°s cukor","aroma","van√≠lia aroma","rum aroma","citroml√©","limel√©","mirelit","mirelit bors√≥","bors√≥","mirelit kukorica","mirelit brokkoli","brokkoli","z√∂ldbab","mirelit z√∂ldbab","mexik√≥i","vegyes z√∂lsd√©g","mirelit z√∂lds√©g","h√∫s","csirkecomb","csirke comb","comb","sert√©s comb","karaj","tarja","oldalas","sz≈±z","hal","lazac","leves mix","levesmix","m√°j","kolb√°sz","sz√°razkolb√°sz","sz√°raz kolb√°sz","szalonna","kolozsv√°ri szalonna","cs√°sz√°r szalonna","kolozsv√°riszalonna","cs√°sz√°rszalonna","felv√°gott","sonka","szal√°mi","virsli","f≈±szerek","oreg√°no","kakukkf≈±","majoranna","rozmaring","k√∂m√©ny","f≈±szerk√∂m√©ny","pirospaprika","f√ºst√∂ltpaprika","f√ºst√∂lt paprika","bors","tarkabors","sz√≠nesbors","kapor","fokhagymapor","fokhagyma por","fokhagymagranul√°tum","fokhagyma granul√°tum","leveskocka","ketchup","kecsap","majon√©z","must√°r","sajt","kem√©nysajt","lapka sajt","lapkasajt","parmez√°n","grana padano","sajtkr√©m","sajt kr√©m","kr√©msajt","tejf√∂l","joghurt","tej","tejsz√≠n","tejsz√≠nhab","toj√°s","keny√©r","kifli","zsemle","tortilla","p√©ks√ºti","p√©kcucc","s√ºti","√ºccsi","√ºd√≠t≈ë","k√≥la","cola","narancsl√©","gy√ºm√∂lcsle","gy√ºmil√©","gy√∂mb√©r","sz√∂rp","pink tonik","pinktonik","pink tonic","tej"],
        penny: ["mogyor√≥","aszalt gy√ºm√∂lcs","ban√°n","alma","narancs","citrom","v√©rnarancs","sz≈ël≈ë","gy√ºm√∂lcs","mandarin","gomba","krumpli","hagyma","fokhagyma","paprika","paradicsom","√∫jhagyma","t√∂k","lilahagyma","r√©pa","levesz√∂lsd√©g","zeller","toj√°s","gabonapehely","lekv√°r","nutella","m√©z","k√°v√©","tea","citroml√©","limel√©","keksz","csoki","gumicukor","√©dess√©g","r√°gcsa","snack","chips","√ºccsi","√ºd√≠t≈ë","k√≥la","cola","narancsl√©","gy√ºm√∂lcsle","gy√ºmil√©","gy√∂mb√©r","sz√∂rp","pink tonik","pinktonik","pink tonic","bor","feh√©rbor","v√∂r√∂sbor","vodka","gagyi vodka","gagyivodka","pezsg≈ë","s√∂r","t√©szta","mamat√©szta","mama t√©szta","szarvacska","spagetti","farfelle","penne","rizs","rizsa","tarhonya","f≈±szerek","oreg√°no","kakukkf≈±","majoranna","rozmaring","k√∂m√©ny","f≈±szerk√∂m√©ny","pirospaprika","f√ºst√∂ltpaprika","f√ºst√∂lt paprika","bors","tarkabors","sz√≠nesbors","kapor","fokhagymapor","fokhagyma por","fokhagymagranul√°tum","fokhagyma granul√°tum","keny√©r","kifli","zsemle","tortilla","p√©ks√ºti","p√©kcucc","s√ºti","olaj","olivaolaj","oliva olaj","ecet","passata","paradicsomp√ºr√©","paradicsom p√ºr√©","paprikakr√©m","ketchup","kecsap","majon√©z","must√°r","kukorica","konzerv kukorica","kukorica konzerv","saviubi","savany√∫ uborka","mogyor√≥vaj","paprikakr√©m","paprika kr√©m","guly√°skr√©m","olivbogy√≥","olivabogy√≥","sajt","kem√©nysajt","lapka sajt","lapkasajt","parmez√°n","grana padano","sajtkr√©m","sajt kr√©m","kr√©msajt","tejf√∂l","joghurt","tej","tejsz√≠n","tejsz√≠nhab","liszt","s√≥","cukor","barna cukor","pr√©zli","zsemlemorzsa","van√≠li√°s cukor","aroma","van√≠lia aroma","rum aroma","h√∫s","csirkecomb","csirke comb","comb","sert√©s comb","karaj","tarja","oldalas","sz≈±z","hal","lazac","leves mix","levesmix","m√°j","kolb√°sz","sz√°razkolb√°sz","sz√°raz kolb√°sz","szalonna","kolozsv√°ri szalonna","cs√°sz√°r szalonna","kolozsv√°riszalonna","cs√°sz√°rszalonna","felv√°gott","sonka","szal√°mi","virsli","leveskocka","mirelit","mirelit bors√≥","bors√≥","mirelit kukorica","mirelit brokkoli","brokkoli","z√∂ldbab","mirelit z√∂ldbab","mexik√≥i","vegyes z√∂lsd√©g","mirelit z√∂lds√©g","mosogat√≥g√©p s√≥","√∂bl√≠t≈ë","mos√≥szer","v√≠zk≈ëold√≥","szemeteszs√°k","pap√≠rt√∂rl≈ë","wcpap√≠r","wc pap√≠r","kuk√°szs√°k","kukazs√°k","tiszt√≠t√≥szer","mosogat√≥g√©p kapszula","tusf√ºrd≈ë","sampon","vattapamacs","fogkefe","fogkr√©m","dezodor","cica kaja","pamacskaja","macska kaja","macskakaja","macska alom","macskaalom","cica alom","cicaalom"],
        spar: ["mogyor√≥","aszalt gy√ºm√∂lcs","ban√°n","alma","narancs","citrom","v√©rnarancs","sz≈ël≈ë","gy√ºm√∂lcs","mandarin","gomba","krumpli","hagyma","fokhagyma","paprika","paradicsom","√∫jhagyma","t√∂k","lilahagyma","r√©pa","levesz√∂lsd√©g","zeller","toj√°s","sajt","kem√©nysajt","lapka sajt","lapkasajt","parmez√°n","grana padano","sajtkr√©m","sajt kr√©m","kr√©msajt","tejf√∂l","joghurt","tej","tejsz√≠n","tejsz√≠nhab","liszt","s√≥","cukor","barna cukor","pr√©zli","zsemlemorzsa","k√°v√©","tea","m√©z","citroml√©","limel√©","gabonapehely","keksz","csoki","gumicukor","√©dess√©g","r√°gcsa","snack","chips","van√≠li√°s cukor","aroma","van√≠lia aroma","rum aroma","keny√©r","kifli","zsemle","tortilla","p√©ks√ºti","p√©kcucc","s√ºti","olaj","olivaolaj","oliva olaj","ecet","passata","paradicsomp√ºr√©","paradicsom p√ºr√©","paprikakr√©m","ketchup","kecsap","majon√©z","must√°r","kukorica","konzerv kukorica","kukorica konzerv","saviubi","savany√∫ uborka","lekv√°r","nutella","mogyor√≥vaj","paprikakr√©m","paprika kr√©m","guly√°skr√©m","olivbogy√≥","olivabogy√≥","t√©szta","mamat√©szta","mama t√©szta","szarvacska","spagetti","farfelle","penne","rizs","rizsa","tarhonya","f≈±szerek","oreg√°no","kakukkf≈±","majoranna","rozmaring","k√∂m√©ny","f≈±szerk√∂m√©ny","pirospaprika","f√ºst√∂ltpaprika","f√ºst√∂lt paprika","bors","tarkabors","sz√≠nesbors","kapor","fokhagymapor","fokhagyma por","fokhagymagranul√°tum","fokhagyma granul√°tum","h√∫s","csirkecomb","csirke comb","comb","sert√©s comb","karaj","tarja","oldalas","sz≈±z","hal","lazac","leves mix","levesmix","m√°j","kolb√°sz","sz√°razkolb√°sz","sz√°raz kolb√°sz","szalonna","kolozsv√°ri szalonna","cs√°sz√°r szalonna","kolozsv√°riszalonna","cs√°sz√°rszalonna","felv√°gott","sonka","szal√°mi","virsli","leveskocka","√ºccsi","√ºd√≠t≈ë","k√≥la","cola","narancsl√©","gy√ºm√∂lcsle","gy√ºmil√©","gy√∂mb√©r","sz√∂rp","pink tonik","pinktonik","pink tonic","bor","feh√©rbor","v√∂r√∂sbor","vodka","gagyi vodka","gagyivodka","pezsg≈ë","s√∂r","mirelit","mirelit bors√≥","bors√≥","mirelit kukorica","mirelit brokkoli","brokkoli","z√∂ldbab","mirelit z√∂ldbab","mexik√≥i","vegyes z√∂lsd√©g","mirelit z√∂lds√©g","mosogat√≥g√©p s√≥","√∂bl√≠t≈ë","mos√≥szer","v√≠zk≈ëold√≥","szemeteszs√°k","pap√≠rt√∂rl≈ë","wcpap√≠r","wc pap√≠r","kuk√°szs√°k","kukazs√°k","tiszt√≠t√≥szer","mosogat√≥g√©p kapszula","tusf√ºrd≈ë","sampon","vattapamacs","fogkefe","fogkr√©m","dezodor","cica kaja","pamacskaja","macska kaja","macskakaja","macska alom","macskaalom","cica alom","cicaalom"],
    };

    function normalize(text) {
        if (!text) return "";
        return text.toString().toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    function initDatabase() {
        const allProducts = new Set();
        Object.values(storeOrders).forEach(list => list.forEach(item => allProducts.add(item)));
        allProductDatabase = Array.from(allProducts).sort();
    }

    // SAJ√ÅT AJ√ÅNL√ì FRISS√çT√âSE
    function updateSuggestions(searchValue) {
        const container = document.getElementById("custom-suggestions");
        container.innerHTML = "";
        
        const term = normalize(searchValue);
        if (term.length < 2) {
            container.style.display = "none";
            return;
        }

        const filtered = allProductDatabase.filter(p => normalize(p).includes(term));
        
        if (filtered.length > 0) {
            container.style.display = "block";
            filtered.slice(0, 10).forEach(product => {
                const div = document.createElement("div");
                div.className = "suggestion-item";
                div.textContent = product;
                div.onclick = () => {
                    document.getElementById("itemInput").value = product;
                    container.style.display = "none";
                    window.addItem();
                };
                container.appendChild(div);
            });
        } else {
            container.style.display = "none";
        }
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById("login-section").style.display = "none";
            document.getElementById("app").style.display = "block";
            document.getElementById("user-display").textContent = "Szia, " + user.email.split('@')[0];
            initDatabase();
            loadData();
        } else {
            document.getElementById("login-section").style.display = "block";
            document.getElementById("app").style.display = "none";
        }
    });

    window.login = async function() {
        const user = document.getElementById("usernameInput").value.trim().toLowerCase();
        const pass = document.getElementById("passInput").value;
        if(!user || !pass) return;
        try {
            await signInWithEmailAndPassword(auth, user + "@lista.hu", pass);
        } catch (err) { document.getElementById("error").textContent = "Hiba!"; }
    };

    window.logout = () => signOut(auth);

    function loadData() {
        onValue(itemsRef, (snapshot) => {
            items = snapshot.val() || [];
            render();
        });
    }

    window.addItem = function() {
        const input = document.getElementById("itemInput");
        const val = input.value.trim();
        if (!val) return;
        items.push({ id: Date.now(), name: val, checked: false });
        input.value = "";
        document.getElementById("custom-suggestions").style.display = "none";
        window.sortItems();
    };

    window.toggle = (id) => {
        const item = items.find(i => i.id === id);
        if (item) {
            item.checked = !item.checked;
            window.sortItems();
        }
    };

    window.removeItem = (id) => {
        items = items.filter(i => i.id !== id);
        set(itemsRef, items);
    };

    window.clearList = () => {
        if (confirm("T√∂rl√∂d a list√°t?")) { items = []; set(itemsRef, items); }
    };

    window.sortItems = () => {
        const store = document.getElementById("storeSelect").value;
        const order = storeOrders[store] || [];
        items.sort((a, b) => {
            if (a.checked !== b.checked) return a.checked ? 1 : -1;
            const ai = order.map(normalize).indexOf(normalize(a.name));
            const bi = order.map(normalize).indexOf(normalize(b.name));
            return (ai === -1 ? 999 : ai) - (bi === -1 ? 999 : bi);
        });
        set(itemsRef, items);
    };

    function render() {
        const ul = document.getElementById("list");
        ul.innerHTML = "";
        items.forEach(item => {
            const li = document.createElement("li");
            li.dataset.id = item.id;
            li.innerHTML = `
                <div class="drag-handle">‚ò∞</div>
                <div style="flex:1; display:flex; align-items:center; gap:12px; cursor:pointer;" onclick="window.toggle(${item.id})">
                    <span style="font-size:22px;">${item.checked ? "‚úÖ" : "‚ö™"}</span>
                    <span class="${item.checked ? 'checked' : ''}">${item.name}</span>
                </div>
                <button class="delete" onclick="window.removeItem(${item.id})">üóëÔ∏è</button>
            `;
            ul.appendChild(li);
        });

        if (sortable) sortable.destroy();
        sortable = Sortable.create(ul, {
            handle: '.drag-handle',
            animation: 150,
            onEnd: () => {
                const newOrder = [];
                ul.querySelectorAll('li').forEach(el => {
                    const id = parseInt(el.dataset.id);
                    const item = items.find(i => i.id === id);
                    if(item) newOrder.push(item);
                });
                items = newOrder;
                set(itemsRef, items);
            }
        });
    }

    document.getElementById("loginBtn").onclick = window.login;
    document.getElementById("usernameInput").onkeypress = (e) => { if(e.key === "Enter") document.getElementById("passInput").focus(); };
    document.getElementById("passInput").onkeypress = (e) => { if(e.key === "Enter") window.login(); };
    document.getElementById("logoutBtn").onclick = window.logout;
    document.getElementById("addBtn").onclick = window.addItem;
    document.getElementById("clearBtn").onclick = window.clearList;
    document.getElementById("storeSelect").onchange = window.sortItems;

    const itemInput = document.getElementById("itemInput");
    itemInput.oninput = (e) => updateSuggestions(e.target.value);
    itemInput.onkeypress = (e) => { if(e.key === "Enter") window.addItem(); };

    // Bez√°rjuk a list√°t, ha m√°shova kattintunk
    document.addEventListener("click", (e) => {
        if (e.target.id !== "itemInput") {
            document.getElementById("custom-suggestions").style.display = "none";
        }
    });

</script>
</body>
</html>
