<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Bev√°s√°rl√≥lista - Okos funkci√≥val</title>

    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Lista">

    <link rel="icon" type="image/png" href="icon.png">
    <link rel="shortcut icon" href="icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: url('hatter.png') repeat center center;
            background-size: auto;
            margin: 0; padding: 20px; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        #login-section, #app {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px; padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            width: 90%; max-width: 400px;
            margin-top: 20px;
            position: relative;
            z-index: 10;
        }

        h1 { text-align: center; margin-bottom: 20px; font-size: 24px; color: #1c1c1e; }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; position: relative; }
        
        input[type="text"], input[type="password"], select { 
            padding: 12px; border-radius: 10px; border: 1px solid #ccc; 
            font-size: 16px; outline: none; background: #fff !important;
            color: #000; width: 100%; box-sizing: border-box;
        }

        button { padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-size: 16px; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        .btn-primary { background: #007aff; color: white; font-weight: 600; }
        
        #custom-suggestions {
            position: absolute;
            top: 50px; left: 0;
            width: 100%;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }

        .suggestion-header { 
            padding: 8px 12px; font-size: 11px; color: #8e8e93; 
            text-transform: uppercase; background: #f8f8f8; 
            border-top-left-radius: 10px; border-top-right-radius: 10px;
        }

        .suggestion-item { 
            padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 16px; 
            display: flex; justify-content: space-between;
        }
        .suggestion-item .count-badge { font-size: 12px; color: #007aff; background: #e5f1ff; padding: 2px 6px; border-radius: 10px; }
        .suggestion-item:active { background: #f0f0f0; }

        ul { list-style: none; padding: 0; margin-top: 10px; }
        li { 
            background: white; padding: 12px; border-radius: 12px; 
            display: flex; align-items: center; margin-bottom: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .drag-handle { cursor: grab; padding: 0 10px; color: #bbb; font-size: 20px; }
        .checked { text-decoration: line-through; color: #8e8e93 !important; }
        .qty-tag { color: #007aff; font-weight: bold; margin-right: 5px; font-size: 14px; }
        .delete { background: none; font-size: 20px; color: #ff3b30; margin-left: auto; padding: 5px; }
        
        .logout-container { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; background: rgba(0,0,0,0.05); 
            padding: 8px 12px; border-radius: 10px; font-size: 14px;
        }
    </style>
</head>
<body>

<div id="login-section">
    <h1>üõí Lista</h1>
    <div id="login-form">
        <input type="text" id="usernameInput" placeholder="Felhaszn√°l√≥n√©v" autocorrect="off" autocapitalize="none" />
        <input type="password" id="passInput" placeholder="Jelsz√≥" />
        <button id="loginBtn" class="btn-primary">Bel√©p√©s</button>
        <p id="error" style="color:#ff3b30; font-size: 14px; margin-top: 10px; text-align: center;"></p>
    </div>
</div>

<div id="app" style="display:none;">
    <div class="logout-container">
        <span id="user-display"></span>
        <button id="logoutBtn">Kil√©p√©s</button>
    </div>
    
    <h1>Bev√°s√°rl√≥lista</h1>
    
    <div class="controls">
        <input type="text" id="itemInput" placeholder="Mit v√°s√°rolsz?" autocomplete="off" />
        <div id="custom-suggestions"></div>
        <button id="addBtn" class="btn-primary">‚ûï</button>
    </div>

    <div class="controls">
        <select id="storeSelect">
            <option value="aldi">Aldi</option>
            <option value="penny">Penny</option>
            <option value="spar">Spar</option>
        </select>
        <button id="clearBtn">üóëÔ∏è</button>
    </div>

    <ul id="list"></ul>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Firebase config ugyanaz marad
    const firebaseConfig = {
        apiKey: "AIzaSyCslE4Kc229j41Sm2l7ovpc_KEWhOb107k",
        authDomain: "bevasarlolista-dd660.firebaseapp.com",
        databaseURL: "https://bevasarlolista-dd660-default-rtdb.firebaseio.com",
        projectId: "bevasarlolista-dd660",
        storageBucket: "bevasarlolista-dd660.firebasestorage.app",
        messagingSenderId: "482885096675",
        appId: "1:482885096675:web:f569deb724cb835358e1d6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const itemsRef = ref(db, 'items');
    const statsRef = ref(db, 'stats'); // √öJ: Statisztika √°ga

    let items = [];
    let stats = {};
    let sortable = null;
    let allProductDatabase = [];

    // Store orders maradt a r√©gi...
    const storeOrders = {
        aldi: ["k√°v√©","tea","m√©z","lekv√°r","nutella","mogyor√≥vaj","gabonapehely","keksz","csoki","gumicukor","√©dess√©g","r√°gcsa","snack","chips","popcorn","ban√°n","alma","k√∂rte","narancs","citrom","sz≈ël≈ë","krumpli","hagyma","fokhagyma","paprika","paradicsom","tej","tejf√∂l","sajt","vaj","toj√°s","keny√©r","virsli","sonka","szal√°mi","t√©szta","rizs","olaj","liszt","cukor","s√≥","mirelit","mos√≥szer","wcpap√≠r","cica kaja","√ºd√≠t≈ë","s√∂r","bor"],
        penny: ["ban√°n","alma","krumpli","hagyma","tej","keny√©r","toj√°s","t√©szta","rizs","cukor","s√≥","olaj","h√∫s","felv√°gott","sajt","√ºd√≠t≈ë","√©dess√©g","tiszt√≠t√≥szer"],
        spar: ["tej","keny√©r","toj√°s","felv√°gott","sajt","z√∂lds√©g","gy√ºm√∂lcs","h√∫s","t√©szta","liszt","olaj","√©dess√©g","ital","tiszt√≠t√≥szer"]
    };

    function normalize(text) {
        if (!text) return "";
        return text.toString().toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    function initDatabase() {
        const allProducts = new Set();
        Object.values(storeOrders).forEach(list => list.forEach(item => allProducts.add(item)));
        allProductDatabase = Array.from(allProducts);
    }

    // √öJ: Gyakori term√©kek megjelen√≠t√©se vagy sz≈±rt lista n√©pszer≈±s√©g szerint
    function updateSuggestions(searchValue) {
        const container = document.getElementById("custom-suggestions");
        container.innerHTML = "";
        
        let term = normalize(searchValue);
        
        // Ha √ºres a mez≈ë, mutassuk a TOP 5 leggyakoribb term√©ket
        if (term.length === 0) {
            const frequentItems = Object.entries(stats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (frequentItems.length > 0) {
                container.style.display = "block";
                container.innerHTML = '<div class="suggestion-header">Gyakran v√°s√°rolt</div>';
                frequentItems.forEach(([name, count]) => addSuggestionToContainer(name, count, container));
            } else {
                container.style.display = "none";
            }
            return;
        }

        // Keres√©s k√∂zben: vegy√≠tj√ºk a bolti adatb√°zist √©s a statisztik√°t
        const match = term.match(/^[\d.,/ ]*(db|kg|l|liter|g|cs)?\s*(.*)$/i);
        if (match && match[2]) term = match[2];

        if (term.length < 1) { container.style.display = "none"; return; }

        const filtered = allProductDatabase
            .filter(p => normalize(p).includes(term))
            .sort((a, b) => (stats[normalize(b)] || 0) - (stats[normalize(a)] || 0)); // N√©pszer≈±s√©g szerinti rendez√©s

        if (filtered.length > 0) {
            container.style.display = "block";
            filtered.slice(0, 10).forEach(product => addSuggestionToContainer(product, stats[normalize(product)], container));
        } else {
            container.style.display = "none";
        }
    }

    function addSuggestionToContainer(name, count, container) {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.innerHTML = `<span>${name}</span> ${count ? `<span class="count-badge">${count}x</span>` : ''}`;
        div.onclick = () => {
            const currentVal = document.getElementById("itemInput").value;
            const qMatch = currentVal.match(/^([\d.,/ ]+(db|kg|l|liter|g|cs)?\s*)/i);
            const prefix = qMatch ? qMatch[1] : "";
            document.getElementById("itemInput").value = prefix + name;
            container.style.display = "none";
            window.addItem();
        };
        container.appendChild(div);
    }

    // Firebase adatbet√∂lt√©s kieg√©sz√≠tve a statisztik√°val
    function loadData() {
        onValue(itemsRef, (snapshot) => {
            items = snapshot.val() || [];
            render();
        });
        onValue(statsRef, (snapshot) => {
            stats = snapshot.val() || {};
        });
    }

    window.addItem = function() {
        const input = document.getElementById("itemInput");
        let val = input.value.trim();
        if (!val) return;

        const quantityMatch = val.match(/^([\d.,/ ]+(db|kg|l|liter|g|cs)?)\s+(.*)$/i);
        let quantity = "";
        let itemName = val;

        if (quantityMatch) {
            quantity = quantityMatch[1].trim(); 
            itemName = quantityMatch[3].trim(); 
        }

        const isDuplicate = items.some(item => normalize(item.name) === normalize(itemName));
        if (isDuplicate) {
            input.value = "";
            document.getElementById("custom-suggestions").style.display = "none";
            return;
        }

        // √öJ: Statisztika friss√≠t√©se (h√°nyszor adtuk hozz√°)
        const normName = normalize(itemName);
        const newCount = (stats[normName] || 0) + 1;
        set(ref(db, `stats/${normName}`), newCount);

        items.push({ 
            id: Date.now(), 
            name: itemName, 
            qty: quantity,
            checked: false 
        });

        input.value = "";
        document.getElementById("custom-suggestions").style.display = "none";
        window.sortItems();
    };

    // T√∂bbi funkci√≥ (login, logout, toggle, remove, sort, render) ugyanaz marad...
    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById("login-section").style.display = "none";
            document.getElementById("app").style.display = "block";
            document.getElementById("user-display").textContent = "Szia, " + user.email.split('@')[0];
            initDatabase();
            loadData();
        } else {
            document.getElementById("login-section").style.display = "block";
            document.getElementById("app").style.display = "none";
        }
    });

    window.login = async function() {
        const user = document.getElementById("usernameInput").value.trim().toLowerCase();
        const pass = document.getElementById("passInput").value;
        if(!user || !pass) return;
        try {
            await signInWithEmailAndPassword(auth, user + "@lista.hu", pass);
        } catch (err) { document.getElementById("error").textContent = "Hiba!"; }
    };
    window.logout = () => signOut(auth);
    window.toggle = (id) => {
        const item = items.find(i => i.id === id);
        if (item) { item.checked = !item.checked; window.sortItems(); }
    };
    window.removeItem = (id) => { items = items.filter(i => i.id !== id); set(itemsRef, items); };
    window.clearList = () => { if (confirm("T√∂rl√∂d?")) { items = []; set(itemsRef, items); } };
    window.sortItems = () => {
        const store = document.getElementById("storeSelect").value;
        const order = storeOrders[store] || [];
        items.sort((a, b) => {
            if (a.checked !== b.checked) return a.checked ? 1 : -1;
            const ai = order.map(normalize).indexOf(normalize(a.name));
            const bi = order.map(normalize).indexOf(normalize(b.name));
            return (ai === -1 ? 999 : ai) - (bi === -1 ? 999 : bi);
        });
        set(itemsRef, items);
    };

    function render() {
        const ul = document.getElementById("list");
        ul.innerHTML = "";
        items.forEach(item => {
            const li = document.createElement("li");
            li.dataset.id = item.id;
            li.innerHTML = `
                <div class="drag-handle">‚ò∞</div>
                <div style="flex:1; display:flex; align-items:center; gap:8px; cursor:pointer;" onclick="window.toggle(${item.id})">
                    <span style="font-size:22px;">${item.checked ? "‚úÖ" : "‚ö™"}</span>
                    <span class="${item.checked ? 'checked' : ''}">
                        ${item.qty ? `<span class="qty-tag">${item.qty}</span>` : ''} 
                        ${item.name}
                    </span>
                </div>
                <button class="delete" onclick="window.removeItem(${item.id})">üóëÔ∏è</button>
            `;
            ul.appendChild(li);
        });
        if (sortable) sortable.destroy();
        sortable = Sortable.create(ul, { handle: '.drag-handle', animation: 150, onEnd: () => {
            const newOrder = [];
            ul.querySelectorAll('li').forEach(el => {
                const item = items.find(i => i.id === parseInt(el.dataset.id));
                if(item) newOrder.push(item);
            });
            items = newOrder; set(itemsRef, items);
        }});
    }

    document.getElementById("loginBtn").onclick = window.login;
    document.getElementById("logoutBtn").onclick = window.logout;
    document.getElementById("addBtn").onclick = window.addItem;
    document.getElementById("clearBtn").onclick = window.clearList;
    document.getElementById("storeSelect").onchange = window.sortItems;
    const itemInput = document.getElementById("itemInput");
    itemInput.oninput = (e) => updateSuggestions(e.target.value);
    // √öJ: Ha r√°kattintasz az inputra, azonnal j√∂jjenek a gyakoriak
    itemInput.onclick = (e) => updateSuggestions(e.target.value);
    itemInput.onkeypress = (e) => { if(e.key === "Enter") window.addItem(); };
    document.addEventListener("click", (e) => {
        if (e.target.id !== "itemInput") document.getElementById("custom-suggestions").style.display = "none";
    });
</script>
</body>
</html>
